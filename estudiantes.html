<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Módulo de Estudiantes — Solo (independiente)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .page { display:none }
    .page.active { display:block }
    .modal { transition: opacity .2s ease; }
    .modal.inactive { opacity:0; pointer-events:none }
    .spinner { border:2px solid rgba(0,0,0,.1); border-left-color:white; border-radius:9999px; width:1rem; height:1rem; animation:spin 1s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</head>
<body class="bg-gray-100">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Módulo de Estudiantes (Solo)</h1>
        <p class="text-gray-600">Independiente, sin cerebro central. Guarda localmente en el navegador.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnExport" class="px-3 py-2 text-sm font-semibold text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">Exportar CSV</button>
        <label class="px-3 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 cursor-pointer">
          Importar CSV
          <input id="csvInput" type="file" accept=".csv" class="hidden" />
        </label>
      </div>
    </header>

    <nav class="mb-6 grid grid-cols-2 gap-2">
      <button data-tab="form" class="tab-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 border border-gray-200">Registrar</button>
      <button data-tab="list" class="tab-btn px-4 py-2 rounded-lg bg-white shadow font-semibold text-gray-700 border border-gray-200">Lista</button>
    </nav>

    <!-- Página: Formulario -->
    <section id="page-form" class="page active">
      <form id="alumnosForm" class="bg-white p-6 sm:p-8 rounded-xl shadow space-y-8">
        <fieldset class="border-t-4 border-blue-500 pt-6">
          <legend class="text-2xl font-semibold text-gray-700 px-2">Datos del Alumno</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Nombre(s)</label>
                <input id="nombres" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Apellido Paterno</label>
                <input id="apellidoPaterno" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Apellido Materno</label>
                <input id="apellidoMaterno" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
              <input type="date" id="dob" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Género</label>
              <select id="gender" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500">
                <option value="">Seleccione...</option>
                <option>Masculino</option>
                <option>Femenino</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Grado</label>
              <select id="grado" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500"></select>
            </div>
          </div>
        </fieldset>

        <fieldset class="border-t-4 border-green-500 pt-6">
          <legend class="text-2xl font-semibold text-gray-700 px-2">Datos del Padre o Tutor</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Nombre(s) del Tutor</label>
                <input id="parentNombres" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Apellido Paterno</label>
                <input id="parentApellidoPaterno" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Apellido Materno</label>
                <input id="parentApellidoMaterno" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Teléfono del Tutor</label>
              <input id="parentPhone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Dirección del Tutor (Opcional)</label>
              <input id="parentAddress" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700">Email del Tutor (Opcional)</label>
              <input type="email" id="parentEmail" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-green-500">
            </div>
          </div>
        </fieldset>

        <div class="flex justify-end pt-6 border-t border-gray-200">
          <button type="submit" class="submit-btn px-8 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 flex items-center">
            <span class="btn-text">Registrar Alumno</span>
            <span class="spinner ml-2 hidden"></span>
          </button>
        </div>
      </form>
    </section>

    <!-- Página: Lista -->
    <section id="page-list" class="page">
      <div class="bg-white p-6 sm:p-8 rounded-xl shadow space-y-6">
        <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
          <div class="flex-1">
            <label class="text-sm font-medium text-gray-700">Buscar</label>
            <input id="searchInput" placeholder="Nombre o grado..." class="mt-1 w-full px-3 py-2 border rounded-md">
          </div>
          <div class="w-48">
            <label class="text-sm font-medium text-gray-700">Grado</label>
            <select id="filterGrado" class="mt-1 w-full px-3 py-2 border rounded-md">
              <option value="">Todos</option>
            </select>
          </div>
        </div>

        <div id="listContainer" class="overflow-x-auto"></div>
      </div>
    </section>
  </div>

  <!-- Modal genérico mensajes -->
  <div id="msgModal" class="modal inactive fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
      <div id="msgIcon"></div>
      <h3 id="msgTitle" class="text-2xl font-bold mt-2"></h3>
      <p id="msgBody" class="text-gray-600 mt-1"></p>
      <button id="msgClose" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Cerrar</button>
    </div>
  </div>

  <!-- Modal edición -->
  <div id="editModal" class="modal inactive fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 max-w-3xl w-full max-h-screen overflow-y-auto">
      <div id="editContent"></div>
    </div>
  </div>

  <script>
    // ===== Config & Store (independiente) =====
    const STORAGE_KEY = 'escuela_alumnos';
    const grados = [
      'Preescolar 1','Preescolar 2','Preescolar 3',
      'Primaria 1','Primaria 2','Primaria 3','Primaria 4','Primaria 5','Primaria 6',
      'Secundaria 1','Secundaria 2','Secundaria 3'
    ];

    const state = { alumnos: loadFromStorage(), filtered: [] };

    function loadFromStorage(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }
    function saveToStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.alumnos)); }

    // ===== UI helpers =====
    const q = sel => document.querySelector(sel);
    const qa = sel => Array.from(document.querySelectorAll(sel));

    function setPage(tab){
      q('#page-form').classList.toggle('active', tab==='form');
      q('#page-list').classList.toggle('active', tab==='list');
      qa('.tab-btn').forEach(b => b.classList.toggle('bg-blue-50', b.dataset.tab===tab));
      if (tab==='list') renderList();
    }

    function showMsg(type, title, body){
      const modal = q('#msgModal');
      q('#msgIcon').innerHTML = type==='ok'
        ? '<svg class="mx-auto h-10 w-10 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        : '<svg class="mx-auto h-10 w-10 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      q('#msgTitle').textContent = title; q('#msgBody').textContent = body;
      modal.classList.remove('inactive');
    }

    q('#msgClose').addEventListener('click', ()=> q('#msgModal').classList.add('inactive'));

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      // tabs
      qa('.tab-btn').forEach(b => b.addEventListener('click', ()=> setPage(b.dataset.tab)));
      setPage('form');

      // grados selects
      const gradoSel = q('#grado');
      grados.forEach(g => gradoSel.add(new Option(g,g)));
      const filterGrado = q('#filterGrado');
      grados.forEach(g => filterGrado.add(new Option(g,g)));

      // form submit
      const form = q('#alumnosForm');
      const btn = form.querySelector('.submit-btn');
      const txt = form.querySelector('.btn-text');
      const spn = form.querySelector('.spinner');
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!form.checkValidity()) { showMsg('err','Faltan datos','Completa los campos obligatorios.'); return; }
        btn.disabled = true; txt.textContent = 'Guardando...'; spn.classList.remove('hidden');
        const alumno = collectForm();
        state.alumnos.push(alumno); saveToStorage(); form.reset();
        showMsg('ok','¡Guardado!','El alumno ha sido registrado localmente.');
        btn.disabled = false; txt.textContent = 'Registrar Alumno'; spn.classList.add('hidden');
      });

      // filtros lista
      q('#searchInput').addEventListener('input', renderList);
      q('#filterGrado').addEventListener('change', renderList);

      // export/import
      q('#btnExport').addEventListener('click', exportCSV);
      q('#csvInput').addEventListener('change', importCSV);
    });

    function collectForm(){
      return {
        id: Date.now(),
        nombres: q('#nombres').value.trim(),
        apellidoPaterno: q('#apellidoPaterno').value.trim(),
        apellidoMaterno: q('#apellidoMaterno').value.trim(),
        dob: q('#dob').value,
        gender: q('#gender').value,
        grado: q('#grado').value,
        // Todos los datos de contacto son del tutor:
        parentNombres: q('#parentNombres').value.trim(),
        parentApellidoPaterno: q('#parentApellidoPaterno').value.trim(),
        parentApellidoMaterno: q('#parentApellidoMaterno').value.trim(),
        parentPhone: q('#parentPhone').value.trim(),
        parentAddress: q('#parentAddress').value.trim(),
        parentEmail: q('#parentEmail').value.trim(),
      };
    }

    // ===== List render =====
    function renderList(){
      const query = q('#searchInput').value.toLowerCase();
      const g = q('#filterGrado').value;
      const data = state.alumnos.filter(a => {
        const nombre = `${a.nombres||''} ${a.apellidoPaterno||''} ${a.apellidoMaterno||''}`.toLowerCase();
        const hit = !query || nombre.includes(query) || (a.grado||'').toLowerCase().includes(query);
        const gradoOk = !g || a.grado === g; return hit && gradoOk;
      });
      state.filtered = data;

      const rows = data.map(a => `
        <tr class="border-b">
          <td class="px-4 py-2 font-medium text-gray-900">${escapeHtml(a.nombres)} ${escapeHtml(a.apellidoPaterno)} ${escapeHtml(a.apellidoMaterno||'')}</td>
          <td class="px-4 py-2">${escapeHtml(a.grado||'')}</td>
          <td class="px-4 py-2">${escapeHtml(a.parentPhone||'')}</td>
          <td class="px-4 py-2 text-right space-x-3">
            <button class="text-blue-600 hover:underline" onclick="openEdit(${a.id})">Editar</button>
            <button class="text-red-600 hover:underline" onclick="confirmDelete(${a.id})">Eliminar</button>
          </td>
        </tr>`).join('');

      q('#listContainer').innerHTML = `
        <table class="w-full text-sm text-left text-gray-600">
          <thead class="text-xs uppercase bg-gray-50">
            <tr>
              <th class="px-4 py-3">Alumno</th>
              <th class="px-4 py-3">Grado</th>
              <th class="px-4 py-3">Teléfono Tutor</th>
              <th class="px-4 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="4" class="text-center py-10">Sin registros</td></tr>`}</tbody>
        </table>`;
    }

    // ===== Edit/Delete =====
    window.openEdit = function(id){
      const a = state.alumnos.find(x => x.id===id); if(!a) return;
      const html = `
        <h2 class="text-2xl font-bold mb-6">Editar Alumno</h2>
        <form id="editForm" class="space-y-4">
          <input type="hidden" name="id" value="${a.id}">
          ${inputRow('Nombre(s)','nombres',a.nombres)}
          ${inputRow('Apellido Paterno','apellidoPaterno',a.apellidoPaterno)}
          ${inputRow('Apellido Materno','apellidoMaterno',a.apellidoMaterno)}
          ${inputRow('Fecha de Nacimiento','dob',a.dob,'date')}
          ${selectRow('Grado','grado',grados,a.grado)}
          ${inputRow('Teléfono Tutor','parentPhone',a.parentPhone,'tel')}
          ${inputRow('Email Tutor','parentEmail',a.parentEmail,'email')}
          ${inputRow('Dirección Tutor','parentAddress',a.parentAddress)}
          <div class="flex justify-end pt-4 border-t mt-6 gap-3">
            <button type="button" class="px-6 py-2 bg-gray-200 rounded-lg" onclick="closeEdit()">Cancelar</button>
            <button class="px-6 py-2 bg-blue-600 text-white rounded-lg">Guardar</button>
          </div>
        </form>`;
      q('#editContent').innerHTML = html; q('#editModal').classList.remove('inactive');
      q('#editForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target); const id = +fd.get('id');
        const idx = state.alumnos.findIndex(x => x.id===id);
        if (idx>-1){
          state.alumnos[idx] = { ...state.alumnos[idx],
            nombres: fd.get('nombres').trim(),
            apellidoPaterno: fd.get('apellidoPaterno').trim(),
            apellidoMaterno: fd.get('apellidoMaterno').trim(),
            dob: fd.get('dob'), grado: fd.get('grado'),
            parentPhone: fd.get('parentPhone').trim(),
            parentEmail: fd.get('parentEmail').trim(),
            parentAddress: fd.get('parentAddress').trim(),
          };
          saveToStorage(); renderList(); closeEdit(); showMsg('ok','Actualizado','Los cambios se guardaron.');
        }
      });
    }
    window.closeEdit = ()=> q('#editModal').classList.add('inactive');

    window.confirmDelete = function(id){
      if (!confirm('¿Eliminar este alumno?')) return;
      state.alumnos = state.alumnos.filter(a => a.id!==id); saveToStorage(); renderList();
      showMsg('ok','Eliminado','El registro fue eliminado.');
    }

    // ===== CSV =====
    function exportCSV(){
      const cols = [
        'nombres','apellidoPaterno','apellidoMaterno','dob','gender','grado',
        // Solo datos del tutor
        'parentNombres','parentApellidoPaterno','parentApellidoMaterno','parentPhone','parentAddress','parentEmail'
      ];
      const header = cols.join(',');
      const lines = state.alumnos.map(a => cols.map(c => csvEscape(a[c] ?? '')).join(','));
      const csv = [header,...lines].join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'alumnos.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function importCSV(e){
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const rows = String(reader.result).split(/\r?\n/).filter(Boolean);
          const headers = rows.shift().split(',').map(h=>h.trim());
          rows.forEach(line => {
            const vals = parseCSVLine(line);
            const obj = {}; headers.forEach((h,i)=> obj[h]= vals[i] ?? '');
            obj.id = Date.now()+Math.floor(Math.random()*1000);
            state.alumnos.push(obj);
          });
          saveToStorage(); renderList(); showMsg('ok','Importado','Los alumnos fueron importados.');
        } catch(err){ showMsg('err','Error importando', err.message || 'CSV no válido'); }
        e.target.value = '';
      };
      reader.readAsText(file, 'utf-8');
    }

    // ===== Small templating/helpers =====
    function inputRow(label,name,value='',type='text'){
      return `<div><label class="block text-sm font-medium text-gray-700">${label}</label><input name="${name}" type="${type}" value="${escapeAttr(value)}" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>`;
    }
    function selectRow(label,name,options,value=''){
      const opts = options.map(o=>`<option ${o===value?'selected':''}>${o}</option>`).join('');
      return `<div><label class="block text-sm font-medium text-gray-700">${label}</label><select name="${name}" class="mt-1 block w-full px-3 py-2 border rounded-md"><option value="">Seleccione...</option>${opts}</select></div>`;
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
    function csvEscape(v){
      const s = String(v ?? '');
      if (/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    }
    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(inQ){ if(ch==='"'){ if(line[i+1]==='"'){cur+='"'; i++;} else { inQ=false; } } else { cur+=ch; } }
        else { if(ch==='"'){ inQ=true; } else if(ch===','){ out.push(cur); cur=''; } else { cur+=ch; } }
      } out.push(cur); return out;
    }
  </script>
</body>
</html>
